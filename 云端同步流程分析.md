# 云端同步流程分析

## 一、整体流程概览

### 1. 启用云端模式流程

```
用户点击"启用云端模式"按钮
    ↓
handleEnableCloud()
    ↓
检查是否已登录 (mgIsCloudEnabled())
    ↓
检查是否已启用 (localStorage.getItem('mg_cloud_enabled'))
    ↓
调用 mgShowCloudEnableModal() 显示策略选择弹窗
    ↓
用户选择策略（智能合并/以本地为准/以云端为准）
    ↓
执行 mgExecuteFirstSync(policy, conflictInfo)
    ↓
设置 localStorage: mg_cloud_enabled = '1', mg_cloud_migrated_v1 = '1'
```

### 2. 首次同步策略执行流程

#### 策略A：智能合并 (merge)
```
1. 拉取云端设置并智能合并到本地 (mgLoadSettingsFromCloud(true))
2. 拉取云端订单 (mgCloudFetchOrders())
3. 上传本地独有的订单到云端 (mgCloudUpsertOrder())
4. 再次拉取所有订单并合并 (mgCloudFetchOrders())
5. 上传合并后的设置到云端 (mgSyncSettingsToCloud())
```

#### 策略B：以本地为准 (local)
```
1. 上传本地设置到云端 (mgSyncSettingsToCloud())
2. 上传所有本地订单到云端 (mgCloudUpsertOrder())
```

#### 策略C：以云端为准 (cloud)
```
1. 从云端拉取设置并覆盖本地 (mgLoadSettingsFromCloud(false))
2. 从云端拉取订单并覆盖本地 (mgCloudFetchOrders())
```

### 3. 日常同步流程

#### 订单同步
```
保存/修改订单时 (saveAsNew/saveOrder)
    ↓
saveData() 保存到本地
    ↓
检查是否启用云端模式
    ↓
调用 mgCloudUpsertOrder(item) 异步同步
    ↓
使用 upsert 机制（根据 external_id 判断插入或更新）
```

#### 设置同步
```
修改设置时 (doSaveData)
    ↓
保存到本地 localStorage
    ↓
延迟2秒后调用 mgSyncSettingsToCloud()
    ↓
1. 先拉取云端设置并智能合并 (mgLoadSettingsFromCloud(true))
2. 上传合并后的设置到云端 (upsert)
```

### 4. 启动时自动同步流程

```
页面初始化 (init())
    ↓
延迟1秒后执行
    ↓
检查是否启用云端模式 (mg_cloud_enabled === '1')
    ↓
1. 拉取云端设置并智能合并 (mgLoadSettingsFromCloud(true))
2. 拉取云端订单 (mgCloudFetchOrders())
3. 上传本地独有的订单 (mgCloudUpsertOrder())
4. 再次拉取所有订单并合并 (mgCloudFetchOrders())
5. 更新显示 (updateDisplay(), renderScheduleCalendar())
```

## 二、关键函数说明

### 1. mgIsCloudEnabled()
- **作用**：检查是否已登录且 Supabase 客户端可用
- **返回**：`!!(window.__APP_AUTH__ && window.__APP_AUTH__.enabled && mgGetSupabaseClient())`

### 2. mgDetectDataConflict()
- **作用**：检测本地和云端的数据差异
- **返回**：`{ hasConflict, localOrders, cloudOrders, localSettings, cloudSettings, cloudHistory }`

### 3. mgCloudUpsertOrder(item)
- **作用**：上传或更新订单到云端
- **机制**：使用 `upsert`，根据 `external_id` 判断插入或更新
- **重试**：失败时最多重试2次（3秒、6秒后）

### 4. mgSyncSettingsToCloud()
- **作用**：智能合并并上传设置到云端
- **流程**：
  1. 先拉取云端设置并智能合并到本地
  2. 上传合并后的设置到云端

### 5. mgLoadSettingsFromCloud(mergeMode)
- **作用**：从云端拉取设置
- **参数**：
  - `mergeMode = true`：智能合并模式（云端优先，保留本地独有的）
  - `mergeMode = false`：直接覆盖模式

### 6. mgCloudFetchOrders(filters)
- **作用**：从云端拉取订单
- **返回**：转换为本地 history 格式的订单数组

## 三、发现的问题

### ❌ 问题1：启动时同步逻辑可能重复执行
**位置**：`script.js:16570-16607`
- 启动时会自动拉取并合并订单
- 但 `mgCloudFetchOrders()` 返回的数据格式可能不正确
- 可能导致订单数据丢失或格式错误

### ❌ 问题2：mgCloudFetchOrders() 数据转换可能有问题
**位置**：`script.js:15413-15450`
```javascript
const item = o.payload || {};
item.id = o.external_id ? parseInt(o.external_id.replace('h_', '')) : Date.now();
```
- 如果 `external_id` 格式不是 `h_时间戳`，`parseInt` 会返回 `NaN`
- 可能导致订单 ID 错误

### ❌ 问题3：mgMapLocalToCloud() 和反向转换不一致
**位置**：
- `mgMapLocalToCloud()`: `script.js:15290-15337` - 本地 → 云端
- `mgCloudFetchOrders()`: `script.js:15436-15450` - 云端 → 本地
- 两个函数的字段映射可能不完全对应，导致数据丢失

### ❌ 问题4：设置同步时的智能合并逻辑可能有问题
**位置**：`script.js:16147-16247`
- `mgSyncSettingsToCloud()` 先拉取云端设置并合并，然后上传
- 但如果合并过程中出错，会降级为直接上传，可能丢失云端数据

### ❌ 问题5：首次同步时没有检查 artist_id
**位置**：`script.js:15921-15995`
- `mgExecuteFirstSync()` 执行时，某些操作可能没有正确设置 `artist_id`
- 可能导致数据写入到错误的用户账户

### ❌ 问题6：启动时同步没有错误处理
**位置**：`script.js:16575-16602`
- 虽然有 try-catch，但错误处理不够完善
- 如果同步失败，用户可能不知道

### ❌ 问题7：mgCloudMigrateOnce() 可能被重复调用
**位置**：`script.js:15339-15410`
- 虽然有 `mg_cloud_migrated_v1` 标记，但在某些流程中可能被绕过
- 可能导致重复上传数据

### ❌ 问题8：external_id 生成逻辑可能冲突
**位置**：`script.js:15280-15288`
- `mgEnsureExternalId()` 基于本地 `id` 生成 `external_id`
- 如果本地 `id` 是时间戳，可能与其他设备冲突

### ❌ 问题9：mgCloudFetchOrders() 没有过滤 artist_id（严重问题！）
**位置**：`script.js:15413-15446`
- `mgCloudFetchOrders()` 查询订单时没有添加 `artist_id` 过滤条件
- **可能导致拉取到其他用户的数据！**
- 这是一个严重的安全和隐私问题

### ❌ 问题10：mgCloudFetchOrders() 数据转换逻辑有问题
**位置**：`script.js:15436-15440`
```javascript
item.id = o.external_id ? parseInt(o.external_id.replace('h_', '')) : Date.now();
```
- 如果 `external_id` 是 `h_1234567890`，`parseInt('1234567890')` 会返回 `1234567890`
- 但原来的本地 `id` 可能不是这个值（因为 `external_id` 是基于本地 `id` 生成的）
- 应该直接使用 `payload` 中的原始 `id`，而不是从 `external_id` 反推

## 四、建议的修复方案

### 1. 修复数据转换问题
- 确保 `mgMapLocalToCloud()` 和反向转换的字段完全对应
- 添加数据验证和错误处理

### 2. 改进错误处理
- 在所有同步操作中添加详细的错误日志
- 向用户显示同步状态和错误信息

### 3. 优化启动时同步
- 添加同步状态指示器
- 避免重复同步
- 添加同步失败重试机制

### 4. 改进 external_id 生成
- 使用更可靠的唯一标识符生成方式
- 确保跨设备不会冲突

### 5. 添加数据验证
- 在同步前后验证数据完整性
- 添加数据备份机制

## 六、严重问题总结

### 🔴 必须立即修复的问题

1. **mgCloudFetchOrders() 缺少 artist_id 过滤**
   - 风险：可能拉取到其他用户的数据
   - 影响：数据泄露、数据混乱
   - 修复：在所有查询中添加 `.eq('artist_id', session.user.id)`

2. **数据转换逻辑错误**
   - 风险：订单 ID 可能不正确，导致数据丢失
   - 影响：订单无法正确匹配和更新
   - 修复：直接使用 `payload` 中的原始数据，不要从 `external_id` 反推

3. **启动时同步可能拉取错误数据**
   - 风险：如果问题1和2存在，启动时会拉取并覆盖本地数据
   - 影响：用户数据可能被其他用户的数据覆盖

## 五、测试建议

1. **首次启用测试**
   - 测试三种策略（智能合并、以本地为准、以云端为准）
   - 验证数据是否正确同步

2. **日常同步测试**
   - 测试订单保存/修改时的自动同步
   - 测试设置修改时的自动同步

3. **多设备测试**
   - 在不同设备上启用云端模式
   - 验证数据是否正确合并

4. **错误处理测试**
   - 测试网络断开时的行为
   - 测试同步失败时的重试机制

5. **启动时同步测试**
   - 测试页面刷新后的自动同步
   - 验证数据是否正确合并
