<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美工报价生成器</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- SVG 图标库：扁平化（非 emoji），使用 currentColor 继承按钮颜色 -->
    <svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden">
        <!-- 线性图标（描边） -->
        <symbol id="i-close" viewBox="0 0 24 24">
            <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-settings" viewBox="0 0 24 24">
            <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M19.4 15a8.9 8.9 0 0 0 .1-6l-2 .3a7.2 7.2 0 0 0-1.1-1.9l1.2-1.6a8.9 8.9 0 0 0-5.2-2.2l-.4 2a7.2 7.2 0 0 0-2.2 0l-.4-2A8.9 8.9 0 0 0 4.2 5.8l1.2 1.6a7.2 7.2 0 0 0-1.1 1.9l-2-.3a8.9 8.9 0 0 0 .1 6l2-.3c.3.7.7 1.3 1.1 1.9l-1.2 1.6a8.9 8.9 0 0 0 5.2 2.2l.4-2c.7.1 1.5.1 2.2 0l.4 2a8.9 8.9 0 0 0 5.2-2.2l-1.2-1.6c.5-.6.9-1.2 1.1-1.9l2 .3Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </symbol>
        <symbol id="i-filter" viewBox="0 0 24 24">
            <path d="M4 6h16M7 12h10M10 18h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-search" viewBox="0 0 24 24">
            <path d="M11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M20 20l-3.5-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-trash" viewBox="0 0 24 24">
            <path d="M9 4h6l1 2h4M5 6h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 6l1 14h6l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M10 11v6M14 11v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <!-- 删除图标选项 -->
        <symbol id="i-trash-simple" viewBox="0 0 24 24">
            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11v6M14 11v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-minus-circle" viewBox="0 0 24 24">
            <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M8 12h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-prohibit" viewBox="0 0 24 24">
            <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M8 8l8 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-x-circle" viewBox="0 0 24 24">
            <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M9 9l6 6M15 9l-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-export" viewBox="0 0 24 24">
            <path d="M12 3v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 7l4-4 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 14v5h14v-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </symbol>
        <symbol id="i-back" viewBox="0 0 24 24">
            <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="i-image" viewBox="0 0 24 24">
            <path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M8.5 10.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M4 16l5-5 4 4 3-3 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="i-edit" viewBox="0 0 24 24">
            <path d="M4 20h4l10.5-10.5a2.1 2.1 0 0 0 0-3L16.5 4.5a2.1 2.1 0 0 0-3 0L3 15v5Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M12.5 5.5l6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-receipt" viewBox="0 0 24 24">
            <path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1V2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 7h6M9 11h6M9 15h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>
        <symbol id="i-plus" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </symbol>

        <!-- 实心图标（主操作） -->
        <symbol id="i-plus-solid" viewBox="0 0 24 24">
            <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5Z" fill="currentColor"/>
        </symbol>
        <symbol id="i-calc-solid" viewBox="0 0 24 24">
            <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm2 4h6a1 1 0 0 1 0 2H9a1 1 0 0 1 0-2Zm0 5h1a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Zm5 0h1a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2Zm-5 4h1a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Zm5 0h1a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2Z" fill="currentColor"/>
        </symbol>
    </svg>

    <div class="app-container">
        <!-- 导航栏：报价 | + | 设置 -->
        <nav class="navbar">
            <div class="nav-buttons">
                <!-- 左侧：报价（主业务） -->
                <button class="nav-btn nav-btn-main nav-btn-quote active" onclick="showPage('quote')">排单</button>

                <!-- 中间：开始计算（打开计算抽屉） -->
                <button class="nav-btn nav-btn-plus" id="openCalculatorBtn" type="button" onclick="openCalculatorDrawer()" aria-label="开始计算" title="开始计算">
                    <svg class="icon lg" aria-hidden="true"><use href="#i-plus"></use></svg>
                    <span class="sr-only">开始计算</span>
                </button>

                <!-- 右侧：设置（辅助配置） -->
                <button class="nav-btn nav-btn-main nav-btn-settings" onclick="showPage('settings')">设置</button>
            </div>
        </nav>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 计算页抽屉容器（覆盖在报价/设置之上） -->
            <div id="calculatorDrawer" class="calculator-drawer">
                <div class="calculator-drawer-panel">
                    <div class="calculator-drawer-header">
                        <button type="button" class="btn-icon btn--icon calculator-drawer-close" onclick="closeCalculatorDrawer()" aria-label="关闭计算面板" title="关闭">
                            <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                            <span class="sr-only">关闭</span>
                        </button>
                        <h2 class="calculator-drawer-title">计算报价</h2>
                        <button type="button" class="btn calculator-drawer-action" onclick="calculatePrice()">报价</button>
                    </div>
                    <div class="calculator-drawer-body">
                        <!-- 计算页原有内容 -->
                        <div id="calculator" class="calculator-content">
                <div class="section">
                    <h2>单主信息</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientId">单主ID</label>
                            <input type="text" id="clientId" placeholder="请输入单主ID">
                        </div>
                        <div class="form-group">
                            <label for="contact">联系方式</label>
                            <div class="contact-input-wrapper">
                                <select id="contactType">
                                    <option value="QQ">QQ</option>
                                    <option value="VX">微信</option>
                                    <option value="MHS">米画师</option>
                                    <option value="RED">小红书</option>
                                    <option value="OTHER">其他</option>
                                </select>
                                <input type="text" id="contact" placeholder="请输入联系方式">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startTime">开始时间</label>
                            <input type="date" id="startTime" onchange="calculateDeadline()">
                        </div>
                        <div class="form-group">
                            <label for="deadline">截稿时间</label>
                            <input type="date" id="deadline">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title-row d-flex justify-between items-center">
                        <h2>设置选项</h2>
                        <div class="template-fill-wrap">
                            <button type="button" class="btn" id="templateFillBtn" onclick="toggleTemplateFillDropdown()">模版填表</button>
                            <div id="templateFillDropdown" class="template-fill-dropdown d-none">
                                <select id="templateSelect" onchange="onTemplateSelectChange()">
                                    <option value="">-- 选择模板 --</option>
                                </select>
                                <div class="d-flex gap-2 mt-2">
                                    <button type="button" class="btn small" onclick="loadSelectedTemplate(); closeTemplateFillDropdown();">加载</button>
                                    <button type="button" class="icon-action-btn delete" id="deleteTemplateBtn" onclick="deleteTemplate();" aria-label="删除模板" title="删除">
                                        <svg class="icon sm" aria-hidden="true"><use href="#i-trash-simple"></use></svg>
                                        <span class="sr-only">删除</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 加价类：用途、加急、其他加价类 -->
                    <div class="form-row" id="pricingUpRow">
                        <div class="form-group">
                            <label for="usage">用途</label>
                            <select id="usage"><option value="">--</option></select>
                        </div>
                        <div class="form-group">
                            <label for="urgent">加急</label>
                            <select id="urgent"><option value="">--</option></select>
                        </div>
                    </div>
                    <div id="extraPricingUpSelectsRow" class="form-row d-none">
                        <!-- 动态添加的其他加价类选择器 -->
                    </div>
                    <!-- 折扣类：折扣系数、其他折扣类 -->
                    <div class="form-row" id="pricingDownRow">
                        <div class="form-group">
                            <label for="discount">折扣系数</label>
                            <select id="discount"><option value="">--</option></select>
                        </div>
                    </div>
                    <div id="extraPricingDownSelectsRow" class="form-row d-none">
                        <!-- 动态添加的其他折扣类选择器 -->
                    </div>
                    <!-- 同模、平台费 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sameModel">同模系数</label>
                            <select id="sameModel"><option value="">--</option></select>
                        </div>
                        <div class="form-group">
                            <label for="platform">平台手续费</label>
                            <select id="platform"><option value="">--</option></select>
                        </div>
                    </div>
                    <!-- 其他费用：单独一行 -->
                    <div class="form-row">
                        <div class="form-group flex-col gap-2 flex-1">
                            <label for="otherFeesList">其他费用</label>
                            <div class="d-flex gap-2 other-fee-container">
                                <select id="otherFeeType" onchange="updateOtherFeeAmount()" class="flex-1 min-w-0">
                                    <option value="custom">自定义</option>
                                    <!-- 其他费用类别将通过JavaScript动态添加 -->
                                </select>
                                <input type="text" id="customOtherFeeName" placeholder="费用名称" class="flex-1 min-w-0">
                                <input type="number" id="otherFeeAmount" placeholder="金额" min="0" step="1" class="w-80">
                            </div>
                            <div id="dynamicOtherFees" class="mt-2 flex-col gap-2">
                                <!-- 动态添加的其他费用将显示在这里 -->
                            </div>
                            <button class="btn small self-start" onclick="addDynamicOtherFee()">+ 其他费用</button>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>制品信息</h2>
                    <div id="productsContainer">
                        <!-- 制品信息将通过JavaScript动态添加 -->
                    </div>
                    <button class="btn add-product" onclick="addProduct()">+ 制品</button>
                </div>
                
                <div class="section">
                    <h2>赠品信息</h2>
                    <div id="giftsContainer">
                        <!-- 赠品信息将通过JavaScript动态添加 -->
                    </div>
                    <button class="btn add-product" onclick="addGift()">+ 赠品</button>
                </div>
                
                        <div class="save-template-row d-flex gap-2 items-center">
                            <!-- 保存按钮放在左侧 -->
                            <button class="btn" onclick="saveTemplate()">保存为模板</button>
                            <!-- 输入框放在右侧 -->
                            <input type="text" id="templateName" placeholder="模板名称">
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 报价页（默认主页面） -->
            <div id="quote" class="page active">
                <!-- 排单日历区（作为排单页主视图），去掉外层卡片框，仅保留排单布局 -->
                <div class="schedule-section">
                    <div class="schedule-toolbar d-flex justify-between items-center">
                        <div class="schedule-title-row">
                            <button type="button" class="btn secondary schedule-title-prev" onclick="scheduleCalendarPrevMonth()">‹</button>
                            <button type="button" class="schedule-title-btn" onclick="openScheduleDatePicker()">
                                <span class="schedule-title-month"></span>
                                <span class="schedule-title-stats"></span>
                            </button>
                            <input type="date" id="scheduleTitleDateInput" class="schedule-title-date-input">
                            <button type="button" class="btn secondary schedule-title-next" onclick="scheduleCalendarNextMonth()">›</button>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn secondary schedule-title-today-pill d-none" onclick="scheduleTodoBackToToday()">Today</button>
                            <button type="button" class="btn secondary" id="openHistoryRecordBtn" onclick="openRecordPage()">记录</button>
                        </div>
                    </div>
                    <div id="scheduleCalendar" class="schedule-calendar">
                        <!-- 月历与跨日彩条由 JS 渲染 -->
                    </div>
                    <div id="scheduleTodoSection" class="schedule-todo-section">
                        <div class="schedule-todo-filters">
                            <button type="button" class="schedule-todo-filter-btn" data-filter="all" onclick="setScheduleTodoFilter('all')">所有</button>
                            <button type="button" class="schedule-todo-filter-btn" data-filter="month" onclick="setScheduleTodoFilter('month')">当月</button>
                            <button type="button" class="schedule-todo-filter-btn" data-filter="pending" onclick="setScheduleTodoFilter('pending')">待排</button>
                            <button type="button" class="schedule-todo-filter-btn active" data-filter="today" onclick="setScheduleTodoFilter('today')">今日</button>
                        </div>
                        <h3 id="scheduleTodoTitle" class="schedule-todo-title">当前批次（截稿日：—）</h3>
                        <div id="scheduleTodoModules" class="schedule-todo-modules">
                            <!-- 按排单分模块的制品 todo 由 JS 渲染 -->
                        </div>
                    </div>
                </div>

                <!-- 隐藏的主小票真源区域（仅用于渲染与截图，不在排单主视图中展示） -->
                <div class="section quote-main-receipt-section">
                    <div id="quoteContent" class="quote-content">
                        <!-- 报价内容将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 小票抽屉：作为“小票页”，从左侧滑出 -->
                <div id="receiptDrawer" class="receipt-drawer d-none">
                    <div class="receipt-drawer-overlay" onclick="handleReceiptDrawerClose()"></div>
                    <div class="receipt-drawer-panel">
                        <div class="receipt-drawer-header">
                            <button type="button" class="btn-icon btn--icon receipt-drawer-close" onclick="handleReceiptDrawerClose()" aria-label="关闭小票页" title="关闭">
                                <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                <span class="sr-only">关闭</span>
                            </button>
                            <h2 class="receipt-drawer-title">报价小票</h2>
                            <button type="button" class="btn receipt-drawer-action" onclick="handleReceiptSchedule()">排单</button>
                        </div>
                        <div class="receipt-drawer-body">
                            <div class="receipt-drawer-toolbar d-flex justify-between items-center">
                                <div class="receipt-drawer-toolbar-left">
                                    <span class="receipt-drawer-subtitle">小票</span>
                                </div>
                                <div class="receipt-drawer-toolbar-actions d-flex gap-2 items-center">
                                    <select id="themeSelector" onchange="applyReceiptTheme(this.value)" class="form-control mr-2">
                                        <option value="classic">经典</option>
                                        <option value="modern">现代</option>
                                        <option value="dark">深色</option>
                                        <option value="vintage">复古</option>
                                        <option value="warm">温馨</option>
                                        <option value="nature">清新</option>
                                        <option value="sakura">粉樱</option>
                                        <option value="iceBlue">冰蓝</option>
                                        <optgroup label="自定义主题" id="customThemesGroup"></optgroup>
                                    </select>
                                    <button class="btn secondary btn--icon" onclick="toggleReceiptCustomizationPanel()" aria-label="小票设置" title="小票设置">
                                        <svg class="icon" aria-hidden="true"><use href="#i-settings"></use></svg>
                                        <span class="sr-only">设置</span>
                                    </button>
                                    <button class="btn secondary btn--icon" onclick="saveQuoteAsImage()" aria-label="保存图片" title="存图">
                                        <svg class="icon" aria-hidden="true"><use href="#i-image"></use></svg>
                                        <span class="sr-only">存图</span>
                                    </button>
                                </div>
                            </div>
                            <div class="receipt-drawer-content">
                                <div id="receiptDrawerContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 小票设置弹窗（底部弹出） -->
                <div id="receiptCustomizationModal" class="receipt-customization-modal d-none">
                    <div class="receipt-customization-overlay" onclick="closeReceiptCustomizationPanel()"></div>
                    <div class="receipt-customization-content">
                        <div class="receipt-customization-header">
                            <h2>小票设置</h2>
                            <button class="btn-icon" onclick="closeReceiptCustomizationPanel()">×</button>
                        </div>
                        
                        <div class="receipt-customization-body">
                            <div class="receipt-customization-tabs">
                                <button class="tab-btn active" onclick="switchReceiptTab('settings')">设置</button>
                                <button class="tab-btn" onclick="switchReceiptTab('theme')">主题</button>
                                <button class="tab-btn" onclick="switchReceiptTab('font')">字体</button>
                            </div>
                            <div class="tab-content active" id="settings-tab">

                                <!-- 小票头部设置 -->
                                <div class="section">
                                    <h3>小票头部</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptHeaderImage">小票头部图片</label>
                                            <div class="image-upload-area" id="headerImageUploadArea" ondrop="handleImageDrop(event, 'headerImage')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                                <input type="file" id="receiptHeaderImage" accept="image/*" onchange="handleReceiptImageUpload('headerImage', this.files[0])" title="推荐尺寸: 宽度不超过300px" style="display: none;">
                                                <button type="button" class="upload-btn" onclick="document.getElementById('receiptHeaderImage').click()">上传图片</button>
                                                <small class="text-gray">推荐尺寸: 宽度不超过300px，高度自适应 | 支持拖拽上传</small>
                                                <div class="checkbox-row">
                                                    <div class="checkbox-item">
                                                        <span>跟随系统主题颜色</span>
                                                        <label class="custom-toggle">
                                                            <input type="checkbox" id="followSystemTheme" onchange="updateReceiptInfo('followSystemTheme', this.checked)" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div id="headerImagePreview" class="image-preview"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptTitleText">小票标题</label>
                                            <input type="text" id="receiptTitleText" placeholder="例如：LIST 或 个人作品报价单" onchange="updateReceiptCustomization('titleText', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptOrderNotification">标题后文本</label>
                                            <input type="text" id="receiptOrderNotification" placeholder="例如：单主ID，你有一份订单请查收~" onchange="updateReceiptInfo('orderNotification', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <div class="checkbox-row">
                                                <div class="checkbox-item">
                                                    <span>开始时间</span>
                                                    <label class="custom-toggle">
                                                        <input type="checkbox" id="showStartTime" onchange="updateReceiptInfo('showStartTime', this.checked)" checked>
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <span>截稿时间</span>
                                                    <label class="custom-toggle">
                                                        <input type="checkbox" id="showDeadline" onchange="updateReceiptInfo('showDeadline', this.checked)" checked>
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <span>设计师</span>
                                                    <label class="custom-toggle">
                                                        <input type="checkbox" id="showDesigner" onchange="updateReceiptInfo('showDesigner', this.checked)" checked>
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <span>联系方式</span>
                                                    <label class="custom-toggle">
                                                        <input type="checkbox" id="showContactInfo" onchange="updateReceiptInfo('showContactInfo', this.checked)" checked>
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptCustomText">制品前文本</label>
                                            <input type="text" id="receiptCustomText" placeholder="输入制品前文本" onchange="updateReceiptInfo('customText', this.value)">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 小票尾部设置 -->
                                <div class="section">
                                    <h3>小票尾部</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                        <label for="receiptFooterText1">小票尾部图片前文本</label>
                                        <input type="text" id="receiptFooterText1" placeholder="例如：温馨提示" onchange="updateReceiptCustomization('footerText1', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label for="receiptFooterText2">小票尾部图片后文本</label>
                                        <input type="text" id="receiptFooterText2" placeholder="例如：感谢惠顾" onchange="updateReceiptCustomization('footerText2', this.value)">
                                    </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptFooterImage">小票尾部图片</label>
                                            <div class="image-upload-area" id="footerImageUploadArea" ondrop="handleImageDrop(event, 'footerImage')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                                <input type="file" id="receiptFooterImage" accept="image/*" onchange="handleReceiptImageUpload('footerImage', this.files[0])" title="推荐尺寸: 宽度不超过200px" style="display: none;">
                                                <button type="button" class="upload-btn" onclick="document.getElementById('receiptFooterImage').click()">上传图片</button>
                                                <small class="text-gray">推荐尺寸: 宽度不超过200px，高度自适应 | 支持拖拽上传</small>
                                                <small class="text-gray" style="display:block;margin-top:0.25rem">头尾图跟随系统主题颜色由上方「小票头部」中开关统一控制</small>
                                                <div id="footerImagePreview" class="image-preview"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 主题标签页 -->
                            <div class="tab-content" id="theme-tab">
                                <div class="section">
                                    <h3>自定义主题</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="customThemeName">主题名称</label>
                                            <input type="text" id="customThemeName" placeholder="输入主题名称">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>颜色设置 <span class="color-format-hint">HEX</span></label>
                                            <div class="color-pickers-row">
                                                <div class="color-picker-item">
                                                    <label for="customThemeBg" class="color-picker-label">背景</label>
                                                    <div class="color-picker-wrapper">
                                                        <input type="color" id="customThemeBg" value="#fdfdfd" class="color-picker-round" onchange="updateCustomThemePreview()">
                                                        <span class="color-value" id="customThemeBgValue">#FDFDFD</span>
                                                    </div>
                                                </div>
                                                <div class="color-picker-item">
                                                    <label for="customThemeText" class="color-picker-label">文字</label>
                                                    <div class="color-picker-wrapper">
                                                        <input type="color" id="customThemeText" value="#2d3748" class="color-picker-round" onchange="updateCustomThemePreview()">
                                                        <span class="color-value" id="customThemeTextValue">#2D3748</span>
                                                    </div>
                                                </div>
                                                <div class="color-picker-item">
                                                    <label for="customThemeAccent" class="color-picker-label">强调</label>
                                                    <div class="color-picker-wrapper">
                                                        <input type="color" id="customThemeAccent" value="#4a5568" class="color-picker-round" onchange="updateCustomThemePreview()">
                                                        <span class="color-value" id="customThemeAccentValue">#4A5568</span>
                                                    </div>
                                                </div>
                                                <div class="color-picker-item">
                                                    <label for="customThemeTitle" class="color-picker-label">标题</label>
                                                    <div class="color-picker-wrapper">
                                                        <input type="color" id="customThemeTitle" value="#2d3748" class="color-picker-round" onchange="updateCustomThemePreview()">
                                                        <span class="color-value" id="customThemeTitleValue">#2D3748</span>
                                                    </div>
                                                </div>
                                                <div class="color-picker-item">
                                                    <label for="customThemeDivider" class="color-picker-label">分割</label>
                                                    <div class="color-picker-wrapper">
                                                        <input type="color" id="customThemeDivider" value="#cbd5e0" class="color-picker-round" onchange="updateCustomThemePreview()">
                                                        <span class="color-value" id="customThemeDividerValue">#CBD5E0</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="customThemeBorderRadius">圆角 (px)</label>
                                            <input type="number" id="customThemeBorderRadius" value="0" min="0" max="20">
                                        </div>
                                    </div>
                                    
                                    <!-- 边框设置 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>边框设置</label>
                                            <div class="d-flex flex-wrap gap-2 items-center" style="align-items: center;">
                                                <select id="customThemeBorderStyle" onchange="updateCustomThemeBorder()" class="flex-1" style="min-width: 80px;">
                                                    <option value="none">无边框</option>
                                                    <option value="solid">实线</option>
                                                    <option value="dashed">虚线</option>
                                                    <option value="dotted">点线</option>
                                                    <option value="double">双线</option>
                                                </select>
                                                <input type="number" id="customThemeBorderWidth" value="0" min="0" max="10" step="1" 
                                                       placeholder="宽度" class="w-80" onchange="updateCustomThemeBorder()">
                                                <span>px</span>
                                                <div class="border-color-picker-wrap" title="边框颜色">
                                                    <span class="border-color-swatch" id="customThemeBorderColorSwatch" style="background-color: #cbd5e0;"></span>
                                                    <input type="color" id="customThemeBorderColor" value="#cbd5e0" class="border-color-picker-input" onchange="updateCustomThemeBorder()">
                                                </div>
                                                <span class="color-value" id="customThemeBorderColorValue">#CBD5E0</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 纸张底纹设置 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="customThemeTexture">纸张底纹</label>
                                            <select id="customThemeTexture" onchange="updateCustomThemeTexture()">
                                                <option value="none">无底纹</option>
                                                <option value="paper">纸张纹理</option>
                                                <option value="lined">横线</option>
                                                <option value="grid">网格</option>
                                                <option value="dots">点阵</option>
                                                <option value="vintage">复古纹理</option>
                                                <option value="noise">噪点</option>
                                            </select>
                                            <small class="text-gray">选择纸张底纹样式</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="customThemeTextureOpacity">底纹透明度</label>
                                            <input type="range" id="customThemeTextureOpacity" value="0.1" min="0" max="0.5" step="0.05" 
                                                   onchange="updateCustomThemeTexture()">
                                            <span id="textureOpacityValue" class="text-gray">10%</span>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <button class="btn" onclick="saveCustomTheme()">保存自定义主题</button>
                                            <button class="btn secondary" onclick="loadCurrentThemeToCustom()">从当前主题加载</button>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>已保存的自定义主题</label>
                                            <div id="customThemesList" class="custom-themes-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 字体标签页 -->
                            <div class="tab-content" id="font-tab">
                                <div class="section">
                                    <h3>字体设置</h3>
                                    
                                    <!-- 快速设置：统一字体 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>快速设置（统一字体）</label>
                                            <select id="receiptFontFamily" onchange="handleFontFamilyChange(this.value)">
                                                <option value="Courier New, Source Han Sans SC, Noto Sans SC, PingFang SC, Hiragino Sans GB, Courier, Monaco, Consolas, monospace">等宽字体（默认）</option>
                                                <option value="Source Han Sans SC, Noto Sans SC, PingFang SC, sans-serif">无衬线字体</option>
                                                <option value="Source Han Serif SC, Noto Serif SC, Times New Roman, serif">衬线字体</option>
                                                <option value="Source Han Sans SC, Noto Sans SC, sans-serif">思源黑体（推荐）</option>
                                                <option value="Source Han Serif SC, Noto Serif SC, serif">思源宋体（推荐）</option>
                                                <option value="custom">自定义字体</option>
                                            </select>
                                            <div id="customFontContainer" style="display: none; margin-top: 0.5rem;">
                                                <div class="d-flex gap-2 items-center mb-2">
                                                    <input type="text" id="customFontFamily" placeholder="输入字体名称，例如：Arial, Helvetica, 思源黑体" 
                                                           class="flex-1"
                                                           onchange="updateReceiptFont('fontFamily', this.value)"
                                                           onblur="updateReceiptFont('fontFamily', this.value)"
                                                           list="fontSuggestions">
                                                    <button class="btn small" onclick="detectSystemFonts()" title="检测系统可用字体">检测字体</button>
                                                </div>
                                                <div id="detectedFontsList" class="detected-fonts-list" style="display: none; margin-top: 0.5rem;"></div>
                                            </div>
                                            <datalist id="fontSuggestions">
                                                <!-- 免费可商用字体（推荐） -->
                                                <option value="Source Han Sans SC, Noto Sans SC, sans-serif">思源黑体（免费可商用）</option>
                                                <option value="Noto Sans SC, Source Han Sans SC, sans-serif">Noto Sans（免费可商用）</option>
                                                <option value="Source Han Serif SC, Noto Serif SC, serif">思源宋体（免费可商用）</option>
                                                <option value="Noto Serif SC, Source Han Serif SC, serif">Noto Serif（免费可商用）</option>
                                                <option value="LXGW WenKai, sans-serif">霞鹜文楷（免费可商用）</option>
                                                <option value="LXGW WenKai Mono, monospace">霞鹜文楷等宽（免费可商用）</option>
                                                <option value="Ma Shan Zheng, cursive">马善政毛笔（免费可商用）</option>
                                                <option value="ZCOOL KuaiLe, cursive">站酷快乐体（免费可商用）</option>
                                                <option value="ZCOOL XiaoWei, serif">站酷小薇体（免费可商用）</option>
                                                <option value="ZCOOL QingKe HuangYou, sans-serif">站酷庆科黄油体（免费可商用）</option>
                                                <option value="ZCOOL Addict Italic, cursive">站酷高端黑（免费可商用）</option>
                                                <option value="FZShuTi, serif">方正舒体（需授权）</option>
                                                <option value="FZYaoti, cursive">方正姚体（需授权）</option>
                                                <!-- 系统字体（需注意授权） -->
                                                <option value="Arial, sans-serif">Arial（系统字体）</option>
                                                <option value="Helvetica, Arial, sans-serif">Helvetica（系统字体）</option>
                                                <option value="Times New Roman, serif">Times New Roman（系统字体）</option>
                                                <option value="Georgia, serif">Georgia（系统字体）</option>
                                                <option value="Verdana, sans-serif">Verdana（系统字体）</option>
                                                <option value="Courier New, monospace">Courier New（系统字体）</option>
                                                <!-- 需授权字体（仅作参考） -->
                                                <option value="SimHei, sans-serif">黑体（需授权）</option>
                                                <option value="FangSong, serif">仿宋（需授权）</option>
                                                <option value="PingFang SC, sans-serif">苹方（需授权）</option>
                                                <option value="Hiragino Sans GB, sans-serif">冬青黑体（需授权）</option>
                                            </datalist>
                                            <small class="text-gray" id="fontFamilyHint" style="display: none; margin-top: 0.25rem;">
                                                提示：可以输入多个字体，用逗号分隔，系统会按顺序尝试使用。推荐使用标注"免费可商用"的字体（如思源黑体、Noto Sans等），商用更安全。
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- 分类字体设置 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <div class="checkbox-row">
                                                <div class="checkbox-item">
                                                    <span>启用分类字体设置</span>
                                                    <label class="custom-toggle">
                                                        <input type="checkbox" id="enableCategoryFonts" onchange="toggleCategoryFonts(this.checked)">
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                            </div>
                                            <small class="text-gray">开启后可以为小票的不同部分分别设置字体</small>
                                        </div>
                                    </div>
                                    
                                    <div id="categoryFontsContainer" style="display: none;">
                                        <!-- 标题字体 -->
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="fontTitle">标题字体（小票标题）</label>
                                                <input type="text" id="fontTitle" placeholder="留空则使用正文字体" 
                                                       onchange="updateCategoryFont('title', this.value)"
                                                       onblur="updateCategoryFont('title', this.value)"
                                                       list="fontSuggestions">
                                                <small class="text-gray">例如：Source Han Serif SC, Noto Serif SC, serif</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 正文字体 -->
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="fontBody">正文字体（内容、信息行）</label>
                                                <input type="text" id="fontBody" placeholder="留空则使用默认字体" 
                                                       onchange="updateCategoryFont('body', this.value)"
                                                       onblur="updateCategoryFont('body', this.value)"
                                                       list="fontSuggestions">
                                                <small class="text-gray">例如：Source Han Sans SC, Noto Sans SC, sans-serif</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 价格/数字字体 -->
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="fontNumber">价格/数字字体（价格列、金额）</label>
                                                <input type="text" id="fontNumber" placeholder="留空则使用等宽字体" 
                                                       onchange="updateCategoryFont('number', this.value)"
                                                       onblur="updateCategoryFont('number', this.value)"
                                                       list="fontSuggestions">
                                                <small class="text-gray">例如：Courier New, Consolas, Monaco, monospace（推荐等宽字体）</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 汇总字体 -->
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="fontSummary">汇总字体（小计、总计）</label>
                                                <input type="text" id="fontSummary" placeholder="留空则使用正文字体" 
                                                       onchange="updateCategoryFont('summary', this.value)"
                                                       onblur="updateCategoryFont('summary', this.value)"
                                                       list="fontSuggestions">
                                                <small class="text-gray">例如：Source Han Sans SC, Noto Sans SC, sans-serif</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 尾部字体 -->
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="fontFooter">尾部字体（尾部文字）</label>
                                                <input type="text" id="fontFooter" placeholder="留空则使用正文字体" 
                                                       onchange="updateCategoryFont('footer', this.value)"
                                                       onblur="updateCategoryFont('footer', this.value)"
                                                       list="fontSuggestions">
                                                <small class="text-gray">例如：Source Han Sans SC, Noto Sans SC, sans-serif</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptFontSize">字号 (px)</label>
                                            <input type="number" id="receiptFontSize" value="13" min="10" max="20" step="1" onchange="updateReceiptFont('fontSize', this.value)">
                                        </div>
                                        <div class="form-group">
                                            <label for="receiptFontWeight">字重</label>
                                            <select id="receiptFontWeight" onchange="updateReceiptFont('fontWeight', this.value)">
                                                <option value="300">细 (300)</option>
                                                <option value="400" selected>正常 (400)</option>
                                                <option value="500">中等 (500)</option>
                                                <option value="600">半粗 (600)</option>
                                                <option value="700">粗体 (700)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="receiptLineHeight">行高</label>
                                            <input type="number" id="receiptLineHeight" value="1.3" min="1" max="2" step="0.1" onchange="updateReceiptFont('lineHeight', this.value)">
                                        </div>
                                    </div>
                                    
                                    <!-- 导入字体文件 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>导入字体文件</label>
                                            <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" style="display: none;" onchange="handleFontFileUpload(event)">
                                            <button type="button" class="btn small" onclick="document.getElementById('fontFileInput').click()">选择字体文件</button>
                                            <small class="text-gray">支持格式：TTF, OTF, WOFF, WOFF2（建议文件小于5MB）</small>
                                        </div>
                                    </div>
                                    
                                    <!-- 已导入的字体列表 -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>已导入的字体</label>
                                            <div id="importedFontsList" class="imported-fonts-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="receipt-customization-footer">
                            <button class="btn" onclick="clearReceiptCustomization()">清除设置</button>
                            <button class="btn" onclick="closeReceiptCustomizationPanel()">保存设置</button>
                        </div>
                    </div>
                </div>

                <!-- 历史记录弹窗 -->
                <div id="historyRecordModal" class="history-record-modal d-none">
                    <div class="history-record-overlay" onclick="closeHistoryRecordModal()"></div>
                    <div class="history-record-content">
                        <div class="history-record-header">
                            <h2>记录</h2>
                            <button type="button" class="btn-icon btn--icon" onclick="closeHistoryRecordModal()" aria-label="关闭" title="关闭">
                                <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                <span class="sr-only">关闭</span>
                            </button>
                        </div>
                        <div class="history-record-body">
                            <div class="form-row">
                                <div class="form-group w-full">
                                    <div class="d-flex gap-2">
                                        <input type="text" id="historySearchInput" placeholder="输入关键词搜索..." class="flex-1" oninput="searchHistory()">
                                        <button class="btn secondary btn--icon" onclick="clearHistorySearch()" aria-label="清空搜索" title="清空">
                                            <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                            <span class="sr-only">清空</span>
                                        </button>
                                        <button class="btn secondary btn--icon" id="historyFilterBtn" onclick="toggleHistoryFilterDrawer()" aria-label="筛选" title="筛选">
                                            <svg class="icon" aria-hidden="true"><use href="#i-filter"></use></svg>
                                            <span class="sr-only" id="historyFilterBtnText">筛选</span>
                                            <span id="historyFilterBadge" class="filter-badge d-none">0</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="historyFilterDrawer" class="history-filter-drawer">
                                <div class="filter-drawer-overlay" onclick="closeHistoryFilterDrawer()"></div>
                                <div class="filter-drawer-content">
                                    <div class="filter-drawer-header">
                                        <h3>筛选与排序</h3>
                                        <button class="btn-icon btn--icon" onclick="closeHistoryFilterDrawer()" aria-label="关闭" title="关闭">
                                            <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                            <span class="sr-only">关闭</span>
                                        </button>
                                    </div>
                                    <div class="filter-drawer-body">
                                        <div class="filter-section">
                                            <label class="filter-label">时间范围</label>
                                            <select id="historyTimeFilter" class="filter-select" onchange="onHistoryFilterChange()">
                                                <option value="all">全部</option>
                                                <option value="today">今天</option>
                                                <option value="week">最近一周</option>
                                                <option value="month">最近一月</option>
                                                <option value="custom">自定义</option>
                                            </select>
                                            <div id="historyCustomDateRange" class="d-none mt-2">
                                                <input type="date" id="historyStartDate" class="filter-input" onchange="onHistoryFilterChange()" placeholder="开始日期">
                                                <span class="mx-2">至</span>
                                                <input type="date" id="historyEndDate" class="filter-input" onchange="onHistoryFilterChange()" placeholder="结束日期">
                                            </div>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">价格范围</label>
                                            <div class="d-flex gap-2 items-center">
                                                <input type="number" id="historyMinPrice" class="filter-input flex-1" placeholder="最低价" min="0" step="0.01" onchange="onHistoryFilterChange()">
                                                <span>至</span>
                                                <input type="number" id="historyMaxPrice" class="filter-input flex-1" placeholder="最高价" min="0" step="0.01" onchange="onHistoryFilterChange()">
                                            </div>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">排序方式</label>
                                            <select id="historySortBy" class="filter-select" onchange="onHistoryFilterChange()">
                                                <option value="time-desc">时间（最新）</option>
                                                <option value="time-asc">时间（最早）</option>
                                                <option value="price-desc">价格（高到低）</option>
                                                <option value="price-asc">价格（低到高）</option>
                                                <option value="client-asc">单主ID（A-Z）</option>
                                                <option value="client-desc">单主ID（Z-A）</option>
                                            </select>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">显示方式</label>
                                            <select id="historyGroupBy" class="filter-select" onchange="onHistoryFilterChange()">
                                                <option value="none">列表</option>
                                                <option value="month">按月分组</option>
                                            </select>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">批量操作</label>
                                            <div class="d-flex gap-2">
                                                <button class="btn secondary flex-1" onclick="selectAllHistory()">全选</button>
                                                <button class="btn danger flex-1" id="batchDeleteBtn" onclick="batchDeleteHistory()" disabled>批量删除</button>
                                            </div>
                                        </div>
                                        <div class="filter-section">
                                            <button class="btn w-full" onclick="exportHistoryToExcel(); closeHistoryFilterDrawer();">导出Excel</button>
                                        </div>
                                    </div>
                                    <div class="filter-drawer-footer">
                                        <button class="btn secondary flex-1" onclick="resetHistoryFilters()">重置</button>
                                        <button class="btn flex-1" onclick="applyHistoryFilters(); closeHistoryFilterDrawer();">应用</button>
                                    </div>
                                </div>
                            </div>
                            <div id="historyContainer" class="history-container">
                                <!-- 历史记录由 JS 渲染 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 记录页（简洁列表：单主ID / 金额 / 完成状态） -->
            <div id="record" class="page">
                <div class="schedule-section">
                    <div class="schedule-toolbar d-flex justify-between items-center">
                        <h2 class="schedule-title">记录</h2>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn secondary btn--icon" onclick="exportRecordToExcel()" aria-label="导出Excel" title="导出Excel">
                                <svg class="icon" aria-hidden="true"><use href="#i-export"></use></svg>
                                <span class="sr-only">导出Excel</span>
                            </button>
                            <button type="button" class="btn secondary btn--icon" onclick="showPage('quote')" aria-label="返回" title="返回">
                                <svg class="icon" aria-hidden="true"><use href="#i-back"></use></svg>
                                <span class="sr-only">返回</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group w-full">
                            <div class="d-flex gap-2">
                                <input type="text" id="recordSearchInput" placeholder="输入关键词搜索..." class="flex-1" oninput="applyRecordFilters()">
                                <button class="btn secondary btn--icon" onclick="clearRecordSearch()" aria-label="清空搜索" title="清空">
                                    <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                    <span class="sr-only">清空</span>
                                </button>
                                <button class="btn secondary btn--icon" id="recordFilterBtn" onclick="toggleRecordFilterDrawer()" aria-label="筛选" title="筛选">
                                    <svg class="icon" aria-hidden="true"><use href="#i-filter"></use></svg>
                                    <span class="sr-only" id="recordFilterBtnText">筛选</span>
                                    <span id="recordFilterBadge" class="filter-badge d-none">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="recordFilterDrawer" class="history-filter-drawer">
                        <div class="filter-drawer-overlay" onclick="closeRecordFilterDrawer()"></div>
                        <div class="filter-drawer-content">
                            <div class="filter-drawer-header">
                                <h3>筛选与排序</h3>
                                <button class="btn-icon btn--icon" onclick="closeRecordFilterDrawer()" aria-label="关闭" title="关闭">
                                    <svg class="icon" aria-hidden="true"><use href="#i-close"></use></svg>
                                    <span class="sr-only">关闭</span>
                                </button>
                            </div>
                            <div class="filter-drawer-body">
                                <div class="filter-section">
                                    <label class="filter-label">时间范围</label>
                                    <select id="recordTimeFilter" class="filter-select" onchange="onRecordFilterChange()">
                                        <option value="all">全部</option>
                                        <option value="today">今天</option>
                                        <option value="week">最近一周</option>
                                        <option value="month">最近一月</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                    <div id="recordCustomDateRange" class="d-none mt-2">
                                        <input type="date" id="recordStartDate" class="filter-input" onchange="onRecordFilterChange()" placeholder="开始日期">
                                        <span class="mx-2">至</span>
                                        <input type="date" id="recordEndDate" class="filter-input" onchange="onRecordFilterChange()" placeholder="结束日期">
                                    </div>
                                </div>
                                <div class="filter-section">
                                    <label class="filter-label">价格范围</label>
                                    <div class="d-flex gap-2 items-center">
                                        <input type="number" id="recordMinPrice" class="filter-input flex-1" placeholder="最低价" min="0" step="0.01" onchange="onRecordFilterChange()">
                                        <span>至</span>
                                        <input type="number" id="recordMaxPrice" class="filter-input flex-1" placeholder="最高价" min="0" step="0.01" onchange="onRecordFilterChange()">
                                    </div>
                                </div>
                                <div class="filter-section">
                                    <label class="filter-label">排序方式</label>
                                    <select id="recordSortBy" class="filter-select" onchange="onRecordFilterChange()">
                                        <option value="time-desc">时间（最新）</option>
                                        <option value="time-asc">时间（最早）</option>
                                        <option value="price-desc">价格（高到低）</option>
                                        <option value="price-asc">价格（低到高）</option>
                                        <option value="client-asc">单主ID（A-Z）</option>
                                        <option value="client-desc">单主ID（Z-A）</option>
                                    </select>
                                </div>
                                <div class="filter-section">
                                    <label class="filter-label">显示方式</label>
                                    <select id="recordGroupBy" class="filter-select" onchange="onRecordFilterChange()">
                                        <option value="none">列表</option>
                                        <option value="month">按月分组</option>
                                    </select>
                                </div>
                                <div class="filter-section">
                                    <label class="filter-label">批量操作</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn secondary flex-1" onclick="selectAllHistory()">全选</button>
                                        <button class="btn danger flex-1" id="recordBatchDeleteBtn" onclick="batchDeleteHistory()" disabled>批量删除</button>
                                    </div>
                                </div>
                                <div class="filter-section">
                                    <button class="btn w-full" onclick="exportRecordToExcel(); closeRecordFilterDrawer();">导出Excel</button>
                                </div>
                            </div>
                            <div class="filter-drawer-footer">
                                <button class="btn secondary flex-1" onclick="resetRecordFilters()">重置</button>
                                <button class="btn flex-1" onclick="applyRecordFilters(); closeRecordFilterDrawer();">应用</button>
                            </div>
                        </div>
                    </div>
                    <div id="recordContainer" class="record-container">
                        <!-- 记录列表由 JS 渲染 -->
                    </div>
                </div>
            </div>

            <!-- 设置页 -->
            <div id="settings" class="page">
                <!-- 美工信息 -->
                <div class="section">
                    <h2>美工信息</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="artistId">美工ID</label>
                            <input type="text" id="artistId" placeholder="请输入美工ID" onchange="updateArtistInfo('id', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="artistContact">联系方式</label>
                            <input type="text" id="artistContact" placeholder="请输入联系方式" onchange="updateArtistInfo('contact', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="defaultDuration">默认工期（天）</label>
                            <input type="number" id="defaultDuration" placeholder="请输入默认工期" min="0" step="1" onchange="updateArtistInfo('defaultDuration', this.value)">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="d-flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2>制品设置</h2>
                        <div class="d-flex items-center gap-2">
                            <button class="btn add-product-setting btn-compact" onclick="openAddProductModal()">添加</button>
                            <button class="btn secondary btn-compact" onclick="document.getElementById('excelImportInput').click()">导入</button>
                            <button class="btn secondary btn-compact" onclick="exportToExcel()">导出</button>
                            <input type="file" id="excelImportInput" accept=".xlsx,.xls" class="d-none" onchange="importFromExcel(event)">
                        </div>
                    </div>
                    <div id="productSettingsContainer">
                    <!-- 制品设置将通过JavaScript动态添加 -->
                    </div>
                
                    <!-- 添加制品弹窗 -->
                    <div id="addProductModal" class="modal d-none">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>添加制品设置</h3>
                                <span class="close" onclick="closeAddProductModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>分类</label>
                                        <div id="newProductCategorySelect"></div>
                                    </div>
                                    <div class="form-group">
                                        <label>制品名称</label>
                                        <input type="text" id="newProductName" placeholder="请输入制品名称">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>计价方式</label>
                                        <select id="newProductPriceType">
                                            <option value="fixed">固定价</option>
                                            <option value="double">单双面价</option>
                                            <option value="config">基础+递增价</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 固定价设置 -->
                                <div id="fixedPriceSettings" class="price-settings">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>固定价格</label>
                                            <input type="number" id="newProductPrice" placeholder="请输入固定价格" min="0" step="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 单双面价设置 -->
                                <div id="doublePriceSettings" class="price-settings d-none">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>单面价格</label>
                                            <input type="number" id="newProductPriceSingle" placeholder="请输入单面价格" min="0" step="1">
                                        </div>
                                        <div class="form-group">
                                            <label>双面价格</label>
                                            <input type="number" id="newProductPriceDouble" placeholder="请输入双面价格" min="0" step="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 基础+递增价设置 -->
                                <div id="configPriceSettings" class="price-settings d-none">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>基础配置</label>
                                            <input type="text" id="newProductBaseConfig" placeholder="例如：立牌+底座">
                                        </div>
                                        <div class="form-group">
                                            <label>基础价</label>
                                            <input type="number" id="newProductBasePrice" placeholder="请输入基础价" min="0" step="1">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group flex-1">
                                            <label>递增配置项</label>
                                            <div id="additionalConfigsContainer"></div>
                                            <button type="button" class="btn secondary mt-2" onclick="addAdditionalConfig()">+ 配置项</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn" onclick="saveNewProduct()">保存</button>
                                <button class="btn secondary" onclick="closeAddProductModal()">取消</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="d-flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2>系数设置</h2>
                        <div class="d-flex items-center gap-2">
                            <button class="btn add-product-setting btn-compact" onclick="openAddCoefficientModal()">添加</button>
                            <button class="btn secondary btn-compact" onclick="document.getElementById('coefficientExcelImportInput').click()">导入</button>
                            <button class="btn secondary btn-compact" onclick="exportCoefficientsToExcel()">导出</button>
                            <input type="file" id="coefficientExcelImportInput" accept=".xlsx,.xls" class="d-none" onchange="importCoefficientsFromExcel(event)">
                        </div>
                    </div>

                    <!-- 加价类：用途系数、加急系数，可添加其他 -->
                    <h3 class="coefficient-class-title">加价类</h3>
                    <!-- 用途系数 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('usageCoefficient')">
                            <div class="category-title">用途系数</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="usageCoefficient-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings" id="usageCoefficientSettings">
                                        <!-- 用途系数将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 加急系数 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('urgentCoefficient')">
                            <div class="category-title">加急系数</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="urgentCoefficient-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings">
                                        <!-- 加急系数将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="extraPricingUpContainer"></div>
                    <!-- 加价类、折扣类均为单数时：加价类最后一项与折扣类第一项并排显示 -->
                    <div id="urgentDiscountPairRow" class="coefficient-pair-row d-none"></div>
                    
                    <!-- 折扣类：折扣系数，可添加其他 -->
                    <h3 class="coefficient-class-title">折扣类</h3>
                    <!-- 折扣系数 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('discountCoefficient')">
                            <div class="category-title">折扣系数</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="discountCoefficient-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings">
                                        <!-- 折扣系数将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="extraPricingDownContainer"></div>
                    
                    <!-- 其他类：同模系数、平台手续费、其他费用 -->
                    <h3 class="coefficient-class-title">其他类</h3>
                    <!-- 同模系数 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('sameModelCoefficient')">
                            <div class="category-title">同模系数</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="sameModelCoefficient-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings">
                                        <!-- 同模系数将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 平台手续费 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('platformFee')">
                            <div class="category-title">平台手续费</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="platformFee-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings">
                                        <!-- 平台手续费将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 背景费设置 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('backgroundFee')">
                            <div class="category-title">背景费</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="backgroundFee-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="coefficient-settings">
                                        <div class="mb-2 d-flex items-center gap-2">
                                            <input type="text" value="背景费" class="flex-1" readonly>
                                            <input type="number" id="backgroundFeeInput" min="0" step="1" class="w-80" 
                                                   onchange="updateBackgroundFee(this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他费用 -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('otherFees')">
                            <div class="category-title">其他费用</div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-content d-none" id="otherFees-content">
                            
                            <!-- 其他费用类别 -->
                            <div class="form-row mt-4">
                                <div class="form-group flex-1">
                                    <label>其他费用类别</label>
                                    <div class="d-flex gap-2 mt-2 flex-wrap">
                                        <input type="text" id="newOtherFeeName" placeholder="费用名称" class="flex-1 min-w-0">
                                        <input type="number" id="newOtherFeeAmount" placeholder="金额" min="0" step="1" class="w-80">
                                        <button class="btn btn-compact" onclick="addOtherFee()">添加</button>
                                    </div>
                                </div>
                            </div>
                            <!-- 其他费用列表 -->
                            <div id="otherFeesList" class="other-fees-list mt-4 ml-4">
                                <!-- 其他费用列表将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 工艺设置 -->
                <div class="section">
                    <div class="category-container">
                        <div class="category-header" onclick="toggleCategory('process')">
                            <div class="category-title">工艺设置</div>
                            <div class="category-actions">
                                <button class="btn add-process-setting btn-compact" onclick="openAddProcessModal()">添加</button>
                                <div class="category-toggle">▼</div>
                            </div>
                        </div>
                        <div class="category-content d-none" id="process-content">
                            <div id="processSettingsContainer">
                                <!-- 工艺设置将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 添加系数弹窗 -->
                <div id="addCoefficientModal" class="modal d-none">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>添加系数</h3>
                            <span class="close" onclick="closeAddCoefficientModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="coefficientCategory">系数大类</label>
                                    <select id="coefficientCategory" onchange="updateCoefficientSubType()">
                                        <option value="pricingUp">加价类</option>
                                        <option value="pricingDown">折扣类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>系数小类</label>
                                    <div id="coefficientTypeSelect"></div>
                                    <small id="coefficientTypeHint">根据上方选择的大类输入系数名称</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>系数值项</label>
                                    <div id="coefficientItemsContainer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <!-- 系数值项将通过JavaScript动态添加 -->
                                    </div>
                                    <button type="button" class="btn secondary mt-2" onclick="addCoefficientItem()">+ 系数值</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn" onclick="saveNewCoefficient()">保存</button>
                            <button class="btn secondary" onclick="closeAddCoefficientModal()">取消</button>
                        </div>
                    </div>
                </div>
                
                <!-- 添加工艺设置弹窗 -->
                <div id="addProcessModal" class="modal d-none">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>添加工艺设置</h3>
                            <span class="close" onclick="closeAddProcessModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newProcessName">工艺名称</label>
                                    <input type="text" id="newProcessName" placeholder="请输入工艺名称">
                                </div>
                                <div class="form-group">
                                    <label for="newProcessPrice">价格（每层）</label>
                                    <input type="number" id="newProcessPrice" min="0" step="1">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn" onclick="saveNewProcess()">保存</button>
                            <button class="btn secondary" onclick="closeAddProcessModal()">取消</button>
                        </div>
                    </div>
                </div>
                
                
                
                <div class="d-flex gap-2">
                    <button class="btn save-settings" onclick="saveSettings()">保存设置</button>
                    <button class="btn secondary" onclick="resetToDefaultSettings()">恢复默认设置</button>
                </div>
            </div>
            

        </main>
    </div>

    <!-- 全局轻提示（toast），用于非阻塞提示“排单已更新”等信息 -->
    <div id="globalToast" class="global-toast d-none"></div>

    <script src="script.js?v=20250127-fix-preview-update-v18"></script>
</body>
</html>
