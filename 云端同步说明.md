# 智能同步模式说明

## 概述

**智能同步模式**是云端同步的唯一模式，采用智能合并策略，确保数据不会丢失，适合所有使用场景。

---

## 核心特性

### 1. 订单智能合并
- **使用 `upsert` 机制**：根据 `external_id` 判断
  - 如果 `external_id` 相同 → **更新**（覆盖该订单）
  - 如果 `external_id` 不同 → **新增**（不会删除其他订单）
- **不会丢失数据**：云端其他设备的订单不会丢失
- **示例**：
  - 云端有：订单1(id:1)、订单2(id:2)、订单3(id:3)
  - 设备A上传：订单1(id:1-修改版)、订单4(id:4)
  - 结果：订单1被更新，订单2和3保留，订单4新增

### 2. 设置智能合并
- **制品/工艺/模板**：按 `id` 去重，**云端优先**
  - 如果本地和云端都有相同ID的项 → 云端版本优先，但保留本地独有的
  - 如果只有本地有 → 新增到云端
  - 如果只有云端有 → 保留云端版本
- **计算器设置**：深度合并，**云端优先**
  - 云端修改的配置项会覆盖本地对应项
  - 本地独有的配置项会保留
- **示例**：
  - 云端设置：`{拍立得: 80, 吧唧: 50, 立牌: 100}`
  - 设备A修改：`{拍立得: 100, 吧唧: 50, 卡头: 70}`
  - 合并后：`{拍立得: 80, 吧唧: 50, 立牌: 100, 卡头: 70}`（拍立得被云端覆盖，立牌保留，卡头新增）

---

## 工作流程

### 启动时
1. **自动拉取云端设置**并智能合并到本地
2. **自动拉取云端订单**并智能合并到本地
3. **上传本地独有的订单**到云端
4. 刷新显示

### 日常使用
1. **新订单**：自动同步到云端（使用upsert）
2. **修改订单**：自动同步更新到云端
3. **修改设置**：自动同步到云端（智能合并后再上传）

### 一键上传所有
1. 智能合并设置（云端优先，但保留本地独有的）
2. 智能合并订单（按external_id去重）
3. 上传合并后的设置和订单到云端

---

## 优势

✅ **不会丢失数据**：订单和设置都智能合并，不会覆盖其他设备的数据  
✅ **自动同步**：修改后自动同步，无需手动操作  
✅ **适合所有场景**：单设备、多设备、协作场景都适用  
✅ **简单易用**：无需选择模式，开箱即用  

---

## 关键点澄清

1. **不是清空**：不会清空云端数据，都是使用 `upsert` 机制
2. **智能合并**：设置按ID去重合并，不是整体覆盖
3. **本地优先**：本地修改的设置项会覆盖云端对应项
4. **自动同步**：订单和设置都自动同步，无需手动操作

---

## 首次同步策略选择

### 为什么需要选择？

如果你之前在多个浏览器/设备上使用过，每个设备的数据可能不同。首次启用云端时，系统会检测数据差异，让你选择首次同步策略：

### 三种首次同步策略

1. **智能合并 ⭐ 推荐**
   - 保留所有数据，订单和设置都智能合并
   - 不会丢失任何数据
   - 适合：希望保留所有设备的数据

2. **以本地为准**
   - 本地数据覆盖云端
   - 适合：当前设备是主设备，其他设备的数据不重要

3. **以云端为准**
   - 云端数据覆盖本地
   - 适合：云端是主版本，本地数据不重要

### 后续同步

首次同步后，后续都使用**智能合并模式**，自动同步，不会丢失数据。

---

## 使用建议

- **单设备使用**：直接使用，本地修改会自动同步到云端
- **多设备使用**：首次启用时选择"智能合并"，之后所有设备都使用智能同步模式
- **协作场景**：多人协作时，每个设备的数据都会智能合并，不会丢失

---

## 自动同步机制（借鉴钱迹）

### 自动同步时机

1. **添加/修改/删除订单后**：自动执行一次同步操作
2. **手动同步**：点击"一键上传所有"或"同步未同步数据"按钮

### 未同步数据跟踪

- ✅ **显示未同步数量**：设置页面会显示"（X 条未同步）"提示
- ✅ **优先同步未同步数据**：手动同步时优先同步未同步的数据
- ✅ **自动重试**：同步失败时自动重试（最多2次，间隔3秒、6秒）
- ✅ **断网保护**：断网时数据保存在本地，网络恢复后自动同步

### 同步状态显示

- 设置页面显示同步状态和未同步数量
- 有未同步数据时，按钮文字变为"同步未同步数据（X）"
- 同步成功后自动更新状态

---

## 注意事项

⚠️ **禁用云端模式后**：数据将不再自动同步，但本地数据不会丢失  
⚠️ **首次启用**：如果检测到数据差异，会提示选择首次同步策略  
⚠️ **网络问题**：如果同步失败，数据会保存在本地，会自动重试  
⚠️ **数据安全**：首次同步后，后续都使用智能合并，不会丢失数据  
⚠️ **流量消耗**：同步只上传新增/修改的数据，数据量很小（通常<10KB）
