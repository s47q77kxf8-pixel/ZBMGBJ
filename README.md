# Metton · 接单助手

报价、排单、进度管理一站式工作台。面向画师与美工，支持多种计价方式、系数与工艺，报价以「收银小票」形式展示；支持排单月历、制品进度勾选、结单/撤单/废稿结算、统计分析与跨端数据同步。

📖 **操作指南**：进入设置页，在「美工信息」标题栏右侧点击「操作指南」（图标+文字）可打开，或直接打开 [操作指南.html](操作指南.html)；另有 [操作指南.md](操作指南.md) 供 Markdown 阅读。

---

## 功能概览

- **排单页**：月历视图、当日/当月/待排/所有筛选、制品进度勾选、昼夜模式；点击 + 打开计算抽屉，点击卡片可编辑/小票/备注/撤单/废稿/结单
- **记录页**：历史记录列表，搜索/排序/筛选（时间、状态、价格、**显示方式**：按月分组或全部排序），导入 JSON（覆盖/合并）、导出 JSON/Excel，批量删除
- **统计页**：KPI 卡片、环比/同比、趋势、Top 单主（默认 10 条）、数据分布、制品小类汇总；**时间范围**在面板（本月/本年/全部/自定义），筛选抽屉为时间口径、金额口径、赠品计入、订单状态；支持导出 Excel（含按折扣原因）
- **设置页**：美工信息、制品/系数/工艺/其他费用、结算配置（跑单费、废稿费、优惠原因）、定金比例；制品与系数支持 Excel 批量导入/导出；修改**自动保存**，底部「立即保存」可再次写入；「恢复默认设置」有二次确认
- **计算与报价**：单主信息、用途/加急/折扣/平台费等、制品与赠品、工艺与同模，一键计算；小票自定义（头图/尾图/主题/字体）、保存图片；模板管理（保存/加载常用组合）

### 制品计价方式

| 方式 | 说明 |
|------|------|
| 固定价 | 单一单价，如普通吧唧 50 元/件 |
| 单双面价 | 单面/双面分别定价，如拍立得单面 50、双面 80 |
| 基础+递增价 | 基础配置价 + 每增加单位的价格，如立牌基础 50 + 底座/插件各 30、麻将基础 50 + 每面 30 |
| 按节点收费 | 一个总价按多个节点比例收取，如头像总价 140 元分为草稿 30%、色稿 40%、成图 30%；计算页可改总价与节点比例 |

**恢复默认设置** 将还原为「开放使用」模板：用途系数为自用/无盈利(1)、同人商用(2)、买断(3)、企业/书店(5)；加急/同模/折扣等系数偏保守；默认制品统一为固定价 50、单面 50 双面 80、基础 50 递增 30；平台费米画师/画加 5%。

### 价格计算逻辑

```
单件制品价 = 基础价 × (1 + 同模系数×(柄图数−1)) + 工艺费用×工艺层数
总价 = Σ(各制品价) × 加价类系数连乘 × 折扣类系数连乘 + 其他费用合计 + 平台手续费
```

---

## 快速开始

- 用浏览器直接打开根目录下的 `index.html` 即可使用，无需构建或服务器。
- 依赖通过 CDN 引入：**html2canvas**（导出图片）、**xlsx**（Excel 导入），需联网加载。

本地预览示例：

```bash
# 若已安装 Python
python -m http.server 8080
# 浏览器访问 http://localhost:8080
```

---

## 技术说明

- 纯前端：HTML + CSS + JavaScript，无后端
- 数据与设置保存在浏览器本地（localStorage），清空浏览器数据会丢失
- 推荐使用 Chrome、Edge、Firefox、Safari 等现代浏览器；支持响应式，可在手机端使用

---

## 项目结构

```
MGbaojia/
├── index.html              # 主页面（排单 / 记录 / 统计 / 设置）
├── script.js               # 业务逻辑、计价、排单、统计、小票、历史与设置
├── style.css               # 全局与小票样式
├── README.md               # 本说明
├── 操作指南.html           # 操作指南（应用内可打开，推荐）
├── 操作指南.md             # 操作指南 Markdown 版
└── .gitignore              # Git 忽略配置
```

---

## 使用说明

详细操作见 [操作指南.md](操作指南.md)。以下为界面与入口速查：

### 界面速查（如何打开 / 如何关闭）

| 界面 | 打开方式 | 关闭方式 |
|------|----------|----------|
| **排单页** | 导航「排单」 | 主页面 |
| **计算抽屉** | 导航 **+** 或排单卡片「编辑」 | 左上 × 或点「小票」「覆盖」「新单」后自动关闭 |
| **小票抽屉** | 点「小票」后自动打开；或排单卡片「小票」 | 左上 × 或遮罩 |
| **小票设置面板** | 小票抽屉内「小票设置」图标 | 「保存设置」或遮罩 |
| **排单卡片操作弹窗** | 点击月历排单条或 todo 区排单模块 | 遮罩或 × |
| **结算弹窗** | 排单卡片「撤单」「废稿」「结单」 | 遮罩、× 或「取消」 |
| **记录页** | 排单页右上「记录」图标 | 左上「返回」 |
| **记录页筛选/导出/排序** | 记录页内对应图标 | 遮罩或「应用」 |
| **导入方式弹窗** | 记录页「导入」后选 JSON | 选「覆盖」或「合并」后自动关闭 |
| **统计页** | 排单页右上「统计」图标 | 左上「返回」 |
| **统计页筛选抽屉** | 统计页「筛选」图标 | 遮罩或「应用」；内容为时间口径、金额口径、赠品计入、订单状态（时间范围在统计页面板） |
| **设置页** | 导航「设置」 | 主页面 |
| **添加制品/系数/工艺弹窗** | 设置页对应区块「添加」 | × 或「取消」 |
| **订单备注弹窗** | 计算页单主「备注（智能提取）」或排单卡片「备注」 | × 或「确定」；编辑模式下可粘贴备注后点「智能提取」自动识别制品/赠品 |

### 一、排单页

月历区：‹ › 切换月份；点日期按钮跳转某月；点排单彩条弹出操作菜单。  
todo 区：筛选 当日/当月/待排/所有；勾选制品标记进度（完成状态会保存）；点排单模块弹出操作菜单。  
工具栏：昼夜模式（点击切换，长按跟随系统）；统计、记录 图标。

### 二、计算抽屉

填写单主信息、设置选项、其他费用、制品与赠品；模版填表可加载模板。  
**小票**：生成小票并加入排单，关闭抽屉并打开小票。**覆盖**：仅编辑模式显示，直接保存到原订单，不打开小票。**新单**：仅编辑模式显示，另存为新排单。**保存为模板**：底部保存当前组合。

### 三、小票抽屉

顶部：排单（保存到列表）、主题下拉、小票设置、存图。  
小票设置面板（底部弹出）：设置（头图/尾图/标题等）、主题（边框/底纹）、字体。

### 四、排单卡片操作弹窗

编辑（加载到计算页）、小票（查看/存图）、备注、撤单、废稿、结单。  
撤单/废稿/结单会打开**结算弹窗**：选类型 → 填金额等 → 确定。

### 五、记录页

搜索、排序、筛选（抽屉）；导入（JSON，选覆盖/合并）、导出（JSON/Excel）；批量删除。  
筛选抽屉：**显示方式**（按月分组 / 全部排序）、时间、状态、价格；全选、批量删除。选「全部排序」时按当前排序规则整列表显示，不按月份分组。

### 六、统计页

KPI 卡片、环比/同比（选本月/本年时显示）、趋势、数据分布、制品小类汇总、Top 单主（默认 10 条，点「更多」展开）。  
**时间范围**在面板：本月/本年/全部/自定义（选本月或本年时可切换月份或年份）。  
筛选抽屉：**时间口径**（按记录时间/按截稿日）、金额口径、赠品计入、订单状态（无时间范围，避免与面板重复）。  
无数据时显示「当前筛选条件下暂无订单数据」。导出 Excel（含汇总、按状态/用途/加急/工艺、Top 单主、Top 制品、**按折扣原因**）。

### 七、设置页

美工信息、制品设置（添加/导入/导出）、系数设置（添加/导入/导出）、结算配置（跑单、废稿、优惠原因）、工艺设置（添加）。  
修改会**自动保存**到本机；底部 **「立即保存」** 可再次写入；**「恢复默认设置」** 有二次确认（将恢复为开放使用模板：用途自用/无盈利、同人商用、买断、企业/书店，制品固定 50/单面 50 双面 80/基础 50 递增 30，平台费 5% 等，当前配置会被覆盖）。

### 八、订单备注与智能提取

计算页单主信息处为 **「备注（智能提取）」**；点开备注弹窗可输入或粘贴单主发的备注，点击 **「智能提取」** 自动识别制品与赠品并填入报价表。支持多种写法（如「拍立得 单面 2个」「吧唧 10个」）；写简称（如「吧唧」）可匹配设置中的制品名（如「普通吧唧」）。赠品以「赠品：」开头后的行会识别为赠品。识别成功后有轻提示。

### 九、小票展示规则概要

总览行：无同模无工艺时单价×数量=小计；有同模或工艺时单价列显示「—」。  
明细行：按「单价×数量=小计」可自证；工艺按每层单价分组。

---

## 注意事项

1. **数据存储**：数据与历史均存于浏览器本地（localStorage），更换设备或清空数据会丢失，重要报价建议及时「保存图片」或导出 JSON/Excel 备份。
2. **跨端同步**：记录页支持导入/导出 JSON，可选择覆盖或合并，用于在不同设备间手动同步数据。
3. **模板保存**：模板会保存制品、赠品和设置选项（用途、加急、折扣等），方便快速复用常用配置。
4. **历史记录**：历史记录数量不做限制，建议定期导出 Excel 或保存图片备份；浏览器 localStorage 有容量上限，数据过多可能影响性能。
5. **打印或导出**：打印或导出时，可调整边距以使小票完整显示。
6. **系数设置**：系数、工艺、其他费用等以设置页中当前配置为准，计算页与历史记录会按保存时的设置解释与展示。
7. **移动端优化**：筛选在移动端采用抽屉式设计，点击「筛选」按钮打开。

---

## 更新日志

### 最新版本（2026-02-14）

- 📅 **排单页 Todo 点击优化**：除点击「制品选择框」和「制品名」标记进度外，点击卡片任何空白处（包括制品行间的缝隙）均可直接弹出操作菜单，提升大屏及移动端操作效率。
- 🧾 **定金确认流程（方案 A）**：新排单进入小票页时，不再默认填充已收定金。需在小票顶部点击「确认已收定金」后，方可显示输入框并同步至小票正文，符合「先出报价单、后收确认定金」的业务逻辑。
- ⚙️ **设置引导优化**：添加新制品时，分类输入框提示语改为「输入新增分类 / 选择已有」，明确支持直接手动输入创建新分类。
- 💰 **小票顶部金额预览**：小票抽屉顶部新增「需付定金」实时计算行，样式与「报价金额」保持一致，方便在修改约定金额时实时核对。

### 历史版本（2026-02-06 ~ 2026-02-13）

- 📅 **排单页与日历优化**
    - **Todo 布局升级**：Todo 列表改为单行横向滚动，勾选后文字增加划线效果，优化子节点共享竖线层级。
    - **日历功能增强**：实现已完成/已结单彩条显示与划线沉底，隐藏已结单 Todo；优化彩条排序与 Todo 一致。
    - **交互体验**：新增日历彩条展开图标按钮；优化 Today 按钮位置；修复日历展开遮挡、彩条重叠及 iOS Safari 点击放大的问题。
- 📝 **计算页改进**
    - **时间输入优化**：调整时间输入框顺序为「下单时间 → 开始时间 → 截稿时间」，并优化小屏设备显示。
    - **平台联动**：优化接单平台与手续费联动逻辑，修复非配置平台被覆盖的问题。
- 🧾 **小票展示**
    - **视觉强化**：小票总览行「数量」与「小计」加粗展示；优化抹零优惠及折扣统计的显示逻辑。
- ⚙️ **系统与文档**
    - **默认模板**：统一用途/系数/制品为「开放使用」数值，平台费 5%，制品单面 50 双面 80。
    - **统计修正**：修复统计数据包含已归档排单，确保折扣统计准确。

### 历史版本（2025-02-05）

- 🧾 **默认模板（开放使用）**：恢复默认设置时使用统一模板。用途系数拆分为自用/无盈利(1)、同人商用(2)、买断(3)、企业/书店(5)；加急/同模/折扣/撤单/废稿/优惠/背景费/定金等默认值偏保守；默认制品统一为固定价 50、单面 50 双面 80、基础 50 递增 30；平台费米画师/画加保持 5%。
- 📊 **统计页**：时间范围仅在面板（本月/本年/全部/自定义），筛选抽屉去掉时间范围，仅保留时间口径、金额口径、赠品计入、订单状态；无数据时显示「当前筛选条件下暂无订单数据」；说明中补充「选择本月/本年时显示环比上月/去年」；导出 Excel 增加「按折扣原因」sheet；Top 单主默认显示 10 条，点「更多」展开；数据分布中折扣按「单数/金额」显示（与用途、加急一致）
- 📝 **记录页**：筛选抽屉增加「显示方式」：按月分组 / 全部排序；选「全部排序」时按当前排序规则整列表显示，不按月份分组
- ⚙️ **设置页**：保存按钮改为「立即保存」；修改已自动保存到本机；「恢复默认设置」改为二次确认（将恢复为初始模板，当前配置会被覆盖）；去掉顶部说明与导出/导入设置按钮
- 📌 **订单备注**：单主信息处为「备注（智能提取）」；备注弹窗内说明「输入或粘贴单主发的备注后，点击下方「智能提取」可自动识别制品与赠品并填入报价表」；按钮改为「智能提取」；支持简称匹配（如写「吧唧」可匹配「普通吧唧」）；识别成功后有轻提示；备注图标框稍加宽

### 历史版本（2025-02-04）

- 📁 **项目结构**：README 项目结构说明更新，纳入预览页与方案文档
- 💰 **结算弹窗（结单）**：结单时「本次收款」默认本次应收；显示新平台费、实际单主支付；保存的金额为本次收款，合计实收 = 已收定金 + 本次收款
- 🎨 **结算优惠布局**：优惠原因与「其他原因」均为单行展示

### 历史版本（2025-02-01）

- ✨ **排单页**：月历视图、当日/当月/待排/所有筛选、制品进度勾选、昼夜模式
- ✨ **记录页**：独立页面，搜索/排序/筛选、导入 JSON（覆盖/合并）、导出 JSON/Excel、批量删除
- ✨ **统计页**：KPI 卡片、环比/同比、趋势、Top 榜、时间与金额口径筛选、导出 Excel
- ✨ **结算功能**：排单卡片可撤单、废稿、结单；设置页配置跑单费、废稿费规则
- ✨ **小票自定义**：主题（边框颜色、底纹）、字体（统一/分类、自定义字体导入）
- ✨ **定金比例**：美工信息支持定金比例，小票显示「需付定金」
- ✨ **背景费**：系数设置新增背景费
- ✨ **系数 Excel**：系数支持 Excel 批量导入/导出
- ✨ **历史记录无上限**：取消 20 条限制
- 📖 **操作指南**：设置页美工信息标题栏右侧入口（图标+文字）

### 历史版本（2025-01-27 / v18）

- 模板管理、历史记录编辑、筛选优化、批量操作、Excel 导出增强
