<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置密码</title>
    <link rel="stylesheet" href="style.css?v=20250131-process-input">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
        }
        .page-wrap {
            max-width: 520px;
            margin: 0 auto;
            padding: 16px 14px 28px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 14px;
        }
        .topbar-title {
            font-size: 22px;
            font-weight: 800;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-light);
            margin: 0 0 6px;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .actions .btn {
            flex: 1;
        }
        #message {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            min-height: 1.2em;
        }
        #message.error { color: var(--danger, #e74c3c); }
        #message.success { color: var(--ok, #2ecc71); }
    </style>
</head>
<body>

<div class="page-wrap">
    <div class="topbar">
        <button type="button" class="btn-icon" onclick="window.location.href='login.html'" aria-label="返回" title="返回">
            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="topbar-title">重置密码</div>
        <span style="width: 40px;"></span>
    </div>

    <div class="card" id="card">
        <div class="form-group">
            <label for="newPassword">新密码</label>
            <input type="password" id="newPassword" placeholder="至少6位密码" autocomplete="new-password">
        </div>
        <div class="actions">
            <button type="button" class="btn" onclick="submitNewPassword()">更新密码</button>
            <button type="button" class="btn secondary" onclick="window.location.href='login.html'">去登录</button>
        </div>
        <div id="message"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js?v=20250213"></script>
<script>
    var supabaseClient = null;
    (function() {
        if (window.__SUPABASE__ && window.__SUPABASE__.client) {
            supabaseClient = window.__SUPABASE__.client;
        } else {
            console.error('Supabase 客户端初始化失败');
        }
    })();

    const messageEl = document.getElementById('message');
    const cardEl = document.getElementById('card');

    function showMessage(msg, type = 'success') {
        messageEl.textContent = msg;
        messageEl.className = 'message ' + type;
    }

    async function initRecovery() {
        if (!supabaseClient) {
            showMessage('系统初始化失败，请刷新页面重试', 'error');
            return;
        }

        try {
            const hash = window.location.hash || '';
            const search = window.location.search || '';

            const hasRecovery = hash.includes('type=recovery') || hash.includes('type=magiclink') || search.includes('type=recovery') || search.includes('code=');
            if (!hasRecovery) {
                showMessage('链接无效或已失效，请重新发起重置密码', 'error');
                return;
            }

            if (typeof supabaseClient.auth.exchangeCodeForSession === 'function' && search.includes('code=')) {
                await supabaseClient.auth.exchangeCodeForSession(window.location.href);
            }

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                showMessage('链接可能已过期，请重新发起重置密码', 'error');
                return;
            }

            showMessage('请设置新密码', 'success');
        } catch (e) {
            console.error('initRecovery error:', e);
            showMessage('初始化失败：' + (e && e.message ? e.message : '未知错误'), 'error');
        }
    }

    async function submitNewPassword() {
        if (!supabaseClient) return;
        const np = document.getElementById('newPassword')?.value;
        if (!np || np.length < 6) {
            return showMessage('新密码至少6位', 'error');
        }

        showMessage('正在更新密码...', 'success');
        const { error } = await supabaseClient.auth.updateUser({ password: np });
        if (error) {
            return showMessage('更新失败: ' + error.message, 'error');
        }

        showMessage('密码已更新！正在进入系统...', 'success');
        try {
            history.replaceState(null, '', window.location.pathname);
        } catch (_) {}
        setTimeout(() => window.location.href = 'index.html#settings', 800);
    }

    initRecovery();
</script>

</body>
</html>
