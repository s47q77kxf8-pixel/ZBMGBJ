<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账号登录</title>
    <link rel="stylesheet" href="style.css?v=20250131-process-input">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
        }
        .page-wrap {
            max-width: 520px;
            margin: 0 auto;
            padding: 16px 14px 28px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 14px;
        }
        .topbar-title {
            font-size: 22px;
            font-weight: 800;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 220px;
            position: relative;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-light);
            margin: 0 0 6px;
        }
        .form-group input {
            width: 100%;
            box-sizing: border-box;
        }
        .password-toggle {
            position: absolute;
            right: 8px;
            bottom: 6px;
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .password-toggle:hover {
            color: var(--text);
        }
        .password-toggle svg {
            width: 16px;
            height: 16px;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .actions .btn {
            flex: 1;
        }
        #message {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            min-height: 1.2em;
        }
        #message.error { color: var(--danger, #e74c3c); }
        #message.success { color: var(--ok, #2ecc71); }
    </style>
</head>
<body>

<div class="page-wrap">
    <div class="topbar">
        <button type="button" class="btn-icon" onclick="window.location.href='index.html#settings'" aria-label="返回" title="返回">
            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="topbar-title">账号登录</div>
        <span style="width: 40px;"></span>
    </div>

    <div class="card">
        <div class="form-row">
            <div class="form-group">
                <label for="email">邮箱</label>
                <input type="email" id="email" placeholder="your@email.com" autocomplete="email" autocapitalize="none" spellcheck="false">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="至少6位密码" autocomplete="current-password" autocapitalize="none" spellcheck="false">
                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password', this)" aria-label="显示或隐藏密码" title="显示/隐藏密码">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                </button>
            </div>
        </div>
        <div class="actions">
            <button type="button" class="btn" id="btnLogin" onclick="handleAuth('login')">登录</button>
            <button type="button" class="btn secondary" onclick="handleAuth('signup')">注册账号</button>
        </div>
        <div style="margin-top:10px;text-align:center;">
            <a href="#" id="linkForgot" onclick="requestPasswordReset(); return false;" style="font-size:12px;color:var(--primary);text-decoration:underline;">忘记密码？</a>
        </div>
        <div id="message"></div>
    </div>
</div>

<!-- 引入 Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js?v=20250213"></script>
<script>
    // 使用全局配置的 Supabase 客户端（避免重复声明）
    // 注意：使用 supabaseClient 而不是 supabase，避免与可能的全局变量冲突
    var supabaseClient = null;
    (function() {
        if (window.__SUPABASE__ && window.__SUPABASE__.client) {
            supabaseClient = window.__SUPABASE__.client;
        } else {
            console.error('Supabase 客户端初始化失败');
        }
    })();

    const messageEl = document.getElementById('message');

    function showMessage(msg, type = 'success') {
        messageEl.textContent = msg;
        messageEl.className = 'message ' + type;
    }

    function togglePasswordVisibility(id, btn) {
        const input = document.getElementById(id);
        if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10.586 10.586a2 2 0 1 1 2.828 2.828" fill="none" stroke="currentColor" stroke-width="2"/><path d="m17.94 17.94-2.12-2.12M9.88 9.88l-2.12-2.12M12 5c7 0 10 7 10 7s-1 2-3 4M2 12s3-7 10-7M5 19 19 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>';
        } else {
            input.type = 'password';
            btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>';
        }
    }

    function setBtnLoading(loading) {
        const btns = ['btnLogin', 'btnSignup', 'linkForgot'].map(id => document.getElementById(id));
        btns.forEach(b => {
            if (!b) return;
            b.disabled = loading;
            if (b.tagName === 'A') {
                b.style.pointerEvents = loading ? 'none' : 'auto';
                b.style.opacity = loading ? '0.5' : '1';
            }
        });
    }

    async function handleAuth(type) {
        if (!supabaseClient) {
            return showMessage('系统初始化失败，请刷新页面重试', 'error');
        }
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
            return showMessage('请填写完整信息', 'error');
        }

        setBtnLoading(true);
        showMessage('处理中...', 'success');

        try {
            if (type === 'signup') {
                // 1. 注册逻辑
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    setBtnLoading(false);
                    return showMessage(error.message, 'error');
                }

                // 2. 强制登录以确保拿到 Session
                showMessage('注册成功，正在建立安全连接...', 'success');
                const { data: signInData, error: signInErr } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (signInErr) {
                    setBtnLoading(false);
                    return showMessage('注册成功，但自动登录失败：' + signInErr.message + '。请尝试手动登录。', 'error');
                }

                const session = signInData.session;
                if (!session || !session.access_token) {
                    setBtnLoading(false);
                    return showMessage('注册成功，但未能获取到安全令牌，请尝试重新登录', 'error');
                }

                // 3. 调用 Edge Function 自动建档
                showMessage('身份验证成功，正在初始化档案...', 'success');
                const fnUrl = window.__SUPABASE__.SUPABASE_URL.replace(/\/$/, '') + '/functions/v1/swift-function';

                try {
                    const resp = await fetch(fnUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + session.access_token
                        },
                        body: JSON.stringify({})
                    });

                    const payload = await resp.json().catch(() => ({}));

                    if (!resp.ok || !payload || payload.ok !== true) {
                        const detail = payload && (payload.detail || payload.error || payload.message);
                        throw new Error(detail || ('HTTP ' + resp.status));
                    }

                    showMessage('所有初始化已完成！正在进入系统...', 'success');
                    setTimeout(() => window.location.href = 'index.html#settings', 800);
                } catch (e) {
                    setBtnLoading(false);
                    console.error('建档失败:', e);
                    showMessage('档案初始化失败：' + (e && e.message ? e.message : '网络错误') + '。请联系管理员', 'error');
                }
            } else {
                // 登录逻辑
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    setBtnLoading(false);
                    if (error.message.includes('Email not confirmed')) {
                        messageEl.innerHTML = `登录失败: 邮箱未验证。<br><a href="#" onclick="resendEmail('${email}')" style="color:var(--primary);text-decoration:underline;">重新发送验证邮件</a>`;
                        messageEl.className = 'message error';
                        return;
                    }
                    return showMessage('登录失败: ' + error.message, 'error');
                }

                showMessage('登录成功！正在跳转...', 'success');
                setTimeout(() => window.location.href = 'index.html#settings', 1500);
            }
        } catch (e) {
            setBtnLoading(false);
            showMessage('请求异常：' + (e && e.message ? e.message : '未知错误'), 'error');
        }
    }

    async function resendEmail(email) {
        if (!supabaseClient) return;
        showMessage('正在重发验证邮件...', 'success');
        const { error } = await supabaseClient.auth.resend({
            type: 'signup',
            email: email,
            options: {
                emailRedirectTo: window.location.origin + window.location.pathname
            }
        });
        if (error) showMessage('重发失败: ' + error.message, 'error');
        else showMessage('验证邮件已重发，请查收', 'success');
    }

    async function requestPasswordReset() {
        if (!supabaseClient) {
            return showMessage('系统初始化失败，请刷新页面重试', 'error');
        }

        const email = document.getElementById('email').value;
        if (!email) {
            return showMessage('请先填写邮箱', 'error');
        }

        setBtnLoading(true);
        showMessage('正在发送重置密码邮件...', 'success');

        try {
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + window.location.pathname.replace(/[^\/]*$/, 'reset-password.html')
            });

            if (error) {
                setBtnLoading(false);
                return showMessage('发送失败: ' + error.message, 'error');
            }

            setBtnLoading(false);
            showMessage('已发送重置密码邮件，请去邮箱按提示修改密码（可能在垃圾箱）', 'success');
        } catch (e) {
            setBtnLoading(false);
            return showMessage('发送失败: ' + (e && e.message ? e.message : '网络错误'), 'error');
        }
    }

    async function initPasswordRecoveryIfNeeded() {
        if (!supabaseClient) return;
        try {
            const hash = window.location.hash || '';
            const search = window.location.search || '';
            // 兼容旧版 implicit 和新版 code flow
            const hasRecovery = hash.includes('type=recovery') || hash.includes('type=magiclink') || search.includes('type=recovery') || search.includes('code=');
            if (!hasRecovery) return;

            // PKCE/code flow: 用 code 换 session
            if (typeof supabaseClient.auth.exchangeCodeForSession === 'function' && search.includes('code=')) {
                await supabaseClient.auth.exchangeCodeForSession(window.location.href);
            }

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            // 显示设置新密码 UI
            const card = document.querySelector('.card');
            if (!card) return;
            card.innerHTML = `
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div style="font-size:13px;color:var(--text-light);">请设置新密码</div>
                    <input type="password" id="newPassword" placeholder="至少6位密码" autocomplete="new-password" />
                    <button type="button" class="btn w-full" onclick="submitNewPassword()">更新密码</button>
                    <div id="message"></div>
                </div>
            `;
        } catch (e) {
            console.error('initPasswordRecoveryIfNeeded error:', e);
        }
    }

    async function submitNewPassword() {
        if (!supabaseClient) return;
        const np = document.getElementById('newPassword')?.value;
        if (!np || np.length < 6) {
            return showMessage('新密码至少6位', 'error');
        }
        showMessage('正在更新密码...', 'success');
        const { error } = await supabaseClient.auth.updateUser({ password: np });
        if (error) {
            return showMessage('更新失败: ' + error.message, 'error');
        }
        showMessage('密码已更新！正在进入系统...', 'success');
        // 清理 URL 上的 recovery 参数，避免重复进入
        try {
            history.replaceState(null, '', window.location.pathname);
        } catch (_) {}
        setTimeout(() => window.location.href = 'index.html#settings', 800);
    }

    async function handleLogout() {
        if (!supabaseClient) return;
        try {
            await supabaseClient.auth.signOut();
        } catch (e) {
            console.error('退出失败:', e);
        }
        window.location.href = 'index.html#settings';
    }

    async function initLoginPage() {
        if (!supabaseClient) return;
        const { data: { session } } = await supabaseClient.auth.getSession();
        const card = document.querySelector('.card');
        if (!card) return;

        if (session && session.user && session.user.email) {
            card.innerHTML = `
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div>
                        <div style="font-size:13px;color:var(--text-light);margin-bottom:4px;">当前已登录账号</div>
                        <div style="font-size:15px;font-weight:600;word-break:break-all;">${session.user.email}</div>
                    </div>
                    <button type="button" class="btn w-full" onclick="handleLogout()">退出登录</button>
                </div>
            `;
        }
    }

    initPasswordRecoveryIfNeeded();
    initLoginPage();
</script>

</body>
</html>
