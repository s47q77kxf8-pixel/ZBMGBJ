# 每个制品排单 - 完整方案

> 在订单排期内为每个制品安排「每日计划」（哪天完成几个），支持多数量按日分配，未完成自动顺延。

---

## 一、需求

- **订单排期**：订单有 `startTime`～`deadline`，不变
- **制品日计划**：在排期内，把每个制品安排到具体某天，并设置「该天完成几个」
- **顺延**：某天未完成则未完成部分顺延到次日
- **多数量**：同种制品多个时（如 3 个），可设「第 1 天 2 个、第 2 天 1 个」

---

## 二、数据结构

### 2.1 制品每日计划（可选）

**普通制品**：
```javascript
product.dailyPlan = [
  { date: '2025-01-01', targetQty: 2 },
  { date: '2025-01-02', targetQty: 1 }
];
// targetQty 之和 = product.quantity，date 须在 startTime～deadline 内
```

**按节点收费制品**（priceType === 'nodes'）：
```javascript
product.nodeDailyPlan = [
  { nodeIndex: 0, date: '2025-01-01', targetQty: 2 },  // 草稿
  { nodeIndex: 1, date: '2025-01-02', targetQty: 2 },  // 色稿
  { nodeIndex: 2, date: '2025-01-03', targetQty: 2 }   // 成图
];
// 每节点 targetQty 之和 = product.quantity
```

### 2.2 每日完成记录

```javascript
item.productDailyDone = [
  { productIndex: 0, date: '2025-01-01', doneQty: 1 },
  // 按节点收费时增加 nodeIndex
  { productIndex: 1, nodeIndex: 0, date: '2025-01-01', doneQty: 1 }
];
```

### 2.3 兼容

- 未设 `dailyPlan` 的制品：沿用现有逻辑
- 旧数据无上述字段：行为不变
- **生效范围（方案 1）**：日计划、节点列表等仅对当前订单生效，不写回全局设置或模板

---

## 三、核心逻辑

**待完成数（含顺延）**：
```
待完成(制品i, 日期d) = 当日计划 + Σ(前几日计划 - 前几日实际) - 当日已记录
```

**某日是否显示订单**：无 dailyPlan/nodeDailyPlan 按原逻辑；有则该日有 targetQty>0 即显示。

**按节点收费**：待完成数、顺延、完成判定均按节点维度计算；productDoneStates 仍为制品级，由「所有节点均完成」推导。

---

## 四、UI 设计

### 4.1 日计划编辑

- **入口**：排单卡片操作弹窗 / Todo 卡片 →「日计划」
- **普通制品**：列表展示各制品，每行可设多天的 targetQty
- **按节点收费制品**：列表展示各制品下的各节点，每节点可设多天的 targetQty（每节点 targetQty 之和 = quantity）
- **校验**：sum(targetQty) = quantity（普通制品）或 每节点 sum = quantity（节点制品）
- **快捷**：平均分配

### 4.2 Todo 按日完成

- 有 dailyPlan 的制品：显示「今日计划 X 个 · 已完成 _ 个」，输入框或 +/- 填写
- **按节点收费**：有 nodeDailyPlan 的制品，按节点展示「草稿：今日 2 个 · 已完成 _ 个」等
- 顺延展示：「制品A：今日 2 个（其中 1 个为昨日顺延）」/「草稿：今日 2 个（其中 1 个为昨日顺延）」
- 累计完成 ≥ quantity（或所有节点完成）时，自动勾选完成

### 4.3 今日完成统计（位置 A）

- **位置**：Todo 标题（如「当日：1月2日」）下方、Todo 卡片列表上方
- **内容**：「今日计划 5 个 · 已完成 2 · 待完成 3」
- **条件**：筛选为「当日」且选中日期有 dailyPlan 时显示

### 4.4 彩条展示（方案 B 分段彩条）

- **形式**：彩条按天切分，每段对应一天
- **普通制品**：制品缩写（取制品名首字）+ 数量，如 `[亚2][亚1 钥1][钥1]`
- **按节点收费**：节点缩写（取节点名首字）+ 数量，如 `[草2][色2][成2]`（草稿/色稿/成图）
- **缩写**：制品取制品名首字；节点取节点名首字；重名用「首字+序号」
- **交互**：点击某段弹出该日制品/节点明细（完整名、顺延说明）

---

## 五、实现步骤

| 步骤 | 内容 |
|------|------|
| 1 | 数据结构：支持 dailyPlan、productDailyDone，旧数据兼容 |
| 2 | 日计划编辑 UI：弹窗入口、制品列表、日期范围、**数据校验**、**平均分配**、**日计划可清空** |
| 3 | Todo 按日展示与完成：getScheduleItemsForDate 调整、按日输入、setProductDailyDone、**保存反馈** |
| 4 | 顺延计算：getRemainingForDay，Todo 展示顺延说明 |
| 5 | 今日统计条：scheduleTodaySummary 容器、getTodayProductStats、**无 dailyPlan 时**不展示或提示 |
| 6 | 分段彩条：getScheduleBarsForCalendar 返回 dailySegments，**无 dailyPlan 仍按整条显示**，制品/节点缩写取首字 |
| 7 | **保存后引导**：保存到排单后弹「是否立即设置日计划？」 |
| 8 | **按节点收费扩展**：nodeDailyPlan、productDailyDone 支持 nodeIndex，日计划编辑/Todo/彩条/顺延均支持节点维度 |
| 9 | **补充**：calculatePrice 写入 dailyPlan 到 productPrices；修改排期后校验/清空日计划；productDailyDone 读取校验 productIndex |

---

## 六、涉及文件

| 文件 | 改动 |
|------|------|
| script.js | 日计划编辑、getRemainingForDay、setProductDailyDone、getTodayProductStats、ensureProductDoneStates、getScheduleItemsForDate、renderScheduleTodoSection、getScheduleBarsForCalendar（分段+缩写）；**按节点收费**：nodeDailyPlan、nodeIndex、节点维度日计划/Todo/彩条/顺延 |
| index.html | 日计划编辑面板 DOM、scheduleTodaySummary 容器 |
| style.css | 日计划编辑、按日完成、分段彩条样式 |

---

## 七、已选方案汇总

| 项 | 选择 |
|----|------|
| **生效范围** | **方案 1：只对当前单生效**（日计划、节点列表等仅作用于当前订单，不修改全局/模板） |
| 彩条形式 | 方案 B 分段彩条 |
| 制品缩写 | 取制品名首字 |
| 今日统计位置 | 位置 A（Todo 标题下方） |

---

## 八、必须功能（已纳入实现步骤）

- **日计划可清空** → 步骤 2
- **数据校验** → 步骤 2
- **平均分配** → 步骤 2
- **保存反馈** → 步骤 3
- **无 dailyPlan 的彩条** → 步骤 6
- **保存后引导** → 步骤 7
- **无 dailyPlan 时今日统计** → 步骤 5

### 8.1 补充必须项（建议纳入）

| 功能 | 说明 |
|------|------|
| **修改排期后的日计划** | 用户修改订单 startTime/deadline 后，若 dailyPlan 日期超出新范围，需提示并清空或要求重新编辑 |
| **保存时写入 productPrices** | calculatePrice → quoteData 时，将 dailyPlan/nodeDailyPlan 写入 productPrices，确保覆盖保存不丢失 |
| **JSON 导出/导入兼容** | 导出/导入历史（exportSyncData 等）时，dailyPlan、productDailyDone 随完整对象持久化，不主动 stripping |
| **productDailyDone 健壮性** | 读取时校验 productIndex/nodeIndex 有效，忽略无效项，避免删制品后报错 |

---

## 九、可选增强（后续）

- 日历某日格显示当日计划总数（小角标）
- 彩条段点击支持快速标记今日完成
- 日计划编辑支持「复制昨日计划」「清空重排」
